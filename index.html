<!-- Awal file -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>E-Skul | Sistem Absensi Digital</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* Semua CSS di sini tetap sama seperti sebelumnya */
    /* ... (dari :root sampai bagian CSS akhir) */
  </style>
</head>
<body>
  <!-- Debug Panel, Header, Hero, Sidebar, dan Form Tetap Sama -->
  <!-- Langsung ke bagian daftar absensi dengan tambahan proteksi password -->

  <div class="card">
    <div class="card-header">
      <h3>Daftar Absensi Terkini</h3>
      <button class="btn btn-primary" id="refreshAttendance">Segarkan</button>
    </div>

    <!-- üîê Form Password -->
    <div class="form-group" style="margin: 10px 20px;">
      <label for="accessPassword">Masukkan Password untuk Melihat Daftar</label>
      <input type="password" id="accessPassword" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <button class="btn btn-primary" style="margin-top: 10px;" id="verifyPasswordBtn">Verifikasi</button>
    </div>

    <!-- Tabel disembunyikan default -->
    <div class="table-responsive" id="attendanceTableWrapper" style="display: none;">
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>Nama</th>
            <th>Kelas</th>
            <th>Ekstrakurikuler</th>
            <th>Status</th>
            <th>Tanggal</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="attendanceList">
          <!-- Data akan dimuat secara dinamis -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Toast dan Loader -->
  <div class="toast" id="toast"></div>
  <div class="loader" id="loader"><div class="spinner"></div></div>

  <!-- Firebase + Script Absensi -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      deleteDoc,
      doc,
      query,
      where,
      orderBy,
      limit,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCP2CoMPbYojeh4fFDim2l1KAlduQKa5KU",
      authDomain: "absensi-6aeea.firebaseapp.com",
      projectId: "absensi-6aeea",
      storageBucket: "absensi-6aeea.appspot.com",
      messagingSenderId: "519667816686",
      appId: "1:519667816686:web:d02baae365ad00a40dbbff",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.deleteDoc = deleteDoc;
    window.doc = doc;
    window.query = query;
    window.where = where;
    window.orderBy = orderBy;
    window.limit = limit;
    window.serverTimestamp = serverTimestamp;

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('attendanceDate').value = today;

    const attendanceForm = document.getElementById('attendanceForm');
    const refreshAttendanceBtn = document.getElementById('refreshAttendance');
    const attendanceBtn = document.getElementById('attendanceBtn');
    const toast = document.getElementById('toast');
    const loader = document.getElementById('loader');
    const debugPanel = document.getElementById('debugPanel');
    const debugContent = document.getElementById('debugContent');
    const toggleDebugBtn = document.getElementById('toggleDebug');

    const totalStudentsEl = document.getElementById('totalStudents');
    const todayAttendanceEl = document.getElementById('todayAttendance');
    const attendanceRateEl = document.getElementById('attendanceRate');
    const activeSessionEl = document.getElementById('activeSession');

    const verifyPasswordBtn = document.getElementById('verifyPasswordBtn');
    const accessPasswordInput = document.getElementById('accessPassword');
    const attendanceTableWrapper = document.getElementById('attendanceTableWrapper');

    verifyPasswordBtn.addEventListener('click', () => {
      const inputPassword = accessPasswordInput.value.trim();
      const correctPassword = "admin123";

      if (inputPassword === correctPassword) {
        showToast('Akses diterima. Menampilkan daftar absensi...', 'success');
        attendanceTableWrapper.style.display = 'block';
        loadAttendance();
      } else {
        showToast('Password salah. Akses ditolak.', 'error');
        attendanceTableWrapper.style.display = 'none';
      }
    });

    function updateDebug(message) {
      console.log(message);
      debugContent.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
      debugContent.scrollTop = debugContent.scrollHeight;
    }

    function checkFirebaseConnection() {
      if (window.db) {
        updateDebug('‚úÖ Firebase connected successfully');
        return true;
      } else {
        updateDebug('‚ùå Firebase not connected');
        return false;
      }
    }

    toggleDebugBtn?.addEventListener('click', e => {
      e.preventDefault();
      debugPanel.classList.toggle('show');
    });

    attendanceForm?.addEventListener('submit', async e => {
      e.preventDefault();
      await submitAttendance();
    });

    refreshAttendanceBtn?.addEventListener('click', e => {
      e.preventDefault();
      loadAttendance();
    });

    attendanceBtn?.addEventListener('click', e => {
      e.preventDefault();
      document.getElementById('attendanceFormCard').scrollIntoView({ behavior: 'smooth' });
    });

    function showLoader() {
      loader.style.display = 'flex';
    }

    function hideLoader() {
      loader.style.display = 'none';
    }

    function showToast(message, type = 'info', duration = 3000) {
      toast.textContent = message;
      toast.className = 'toast show';
      if (type === 'error') toast.classList.add('error');
      else if (type === 'success') toast.classList.add('success');

      setTimeout(() => {
        toast.classList.remove('show');
        toast.className = 'toast';
      }, duration);
    }

    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('id-ID', options);
    }

    async function submitAttendance() {
      updateDebug('üîÑ Starting attendance submission...');
      if (!checkFirebaseConnection()) {
        showToast('Firebase tidak terhubung. Silakan refresh halaman.', 'error');
        return;
      }

      const name = document.getElementById('studentName').value.trim();
      const studentClass = document.getElementById('studentClass').value.trim();
      const extracurricular = document.getElementById('extracurricular').value;
      const status = document.getElementById('attendanceStatus').value;
      const date = document.getElementById('attendanceDate').value;
      const notes = document.getElementById('notes').value.trim();

      if (!name || !studentClass || !extracurricular || !status || !date) {
        showToast('Harap lengkapi semua field yang wajib diisi', 'error');
        updateDebug('‚ùå Validation failed: missing required fields');
        return;
      }

      showLoader();
      try {
        const attendanceRef = window.collection(window.db, 'attendance');
        const q = window.query(
          attendanceRef,
          window.where('name', '==', name),
          window.where('date', '==', date),
          window.where('extracurricular', '==', extracurricular)
        );
        const existingSnapshot = await window.getDocs(q);
        if (!existingSnapshot.empty) {
          showToast('Absensi untuk peserta ini sudah tercatat hari ini', 'error');
          return;
        }

        const docRef = await window.addDoc(attendanceRef, {
          name,
          class: studentClass,
          extracurricular,
          status,
          date,
          notes: notes || 'Tidak ada catatan',
          recordedAt: window.serverTimestamp(),
          updatedAt: window.serverTimestamp()
        });

        showToast('Absensi berhasil disimpan!', 'success');
        attendanceForm.reset();
        document.getElementById('attendanceDate').value = today;
        await loadDashboardData();

      } catch (error) {
        console.error(error);
        showToast('Gagal menyimpan: ' + error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    async function loadDashboardData() {
      if (!checkFirebaseConnection()) return;

      showLoader();
      try {
        const todayDate = new Date().toISOString().split('T')[0];
        const attendanceRef = window.collection(window.db, 'attendance');
        const todayQuery = window.query(attendanceRef, window.where('date', '==', todayDate));
        const todaySnapshot = await window.getDocs(todayQuery);
        todayAttendanceEl.textContent = todaySnapshot.size;

        totalStudentsEl.textContent = "150";
        attendanceRateEl.textContent = "90%";
        activeSessionEl.textContent = "2";

      } catch (error) {
        console.error(error);
        showToast('Gagal memuat data dashboard: ' + error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    async function loadAttendance() {
      if (!checkFirebaseConnection()) return;

      const attendanceList = document.getElementById('attendanceList');
      attendanceList.innerHTML = '';

      try {
        const attendanceRef = window.collection(window.db, 'attendance');
        const q = window.query(attendanceRef, window.orderBy('recordedAt', 'desc'), window.limit(10));
        const querySnapshot = await window.getDocs(q);

        if (querySnapshot.empty) {
          attendanceList.innerHTML = '<tr><td colspan="6" style="text-align:center;">Belum ada data absensi</td></tr>';
          return;
        }

        querySnapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          let statusBadge = '';
          if (data.status === 'Hadir') statusBadge = '<span style="color:green;font-weight:bold;">Hadir</span>';
          else if (data.status === 'Izin' || data.status === 'Sakit') statusBadge = '<span style="color:orange;font-weight:bold;">' + data.status + '</span>';
          else statusBadge = '<span style="color:red;font-weight:bold;">Alpa</span>';

          row.innerHTML = `
            <td>${data.name}</td>
            <td>${data.class || '-'}</td>
            <td>${data.extracurricular}</td>
            <td>${statusBadge}</td>
            <td>${formatDate(data.date)}</td>
            <td>
              <button class="btn" style="padding:5px 10px;" onclick="editAttendance('${doc.id}')"><i class="fas fa-edit"></i></button>
              <button class="btn" style="padding:5px 10px;" onclick="deleteAttendance('${doc.id}')"><i class="fas fa-trash"></i></button>
            </td>
          `;
          attendanceList.appendChild(row);
        });
      } catch (error) {
        console.error(error);
        showToast('Gagal memuat daftar absensi: ' + error.message, 'error');
      }
    }

    window.editAttendance = function(id) {
      showToast('Fitur edit akan ditambahkan nanti.', 'info');
    };

    window.deleteAttendance = async function(id) {
      if (!checkFirebaseConnection()) return;
      if (!confirm('Yakin ingin menghapus data ini?')) return;

      showLoader();
      try {
        await window.deleteDoc(window.doc(window.db, 'attendance', id));
        showToast('Data berhasil dihapus.', 'success');
        loadAttendance();
      } catch (error) {
        console.error(error);
        showToast('Gagal menghapus: ' + error.message, 'error');
      } finally {
        hideLoader();
      }
    };

    updateDebug('üöÄ App initialized');
    checkFirebaseConnection();
    loadDashboardData();
  </script>
</body>
</html>